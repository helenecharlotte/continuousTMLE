# Web-appendix-continuous-time-TMLE
* Continuous-time TMLE

** Overview 

- [[https://github.com/helenecharlotte/continuousTMLE#tmle-for-survival-analysis][TMLE for continuous-time survival analysis]]

 + [[https://github.com/helenecharlotte/continuousTMLE#simulated-data-examples-1][Simulated data examples]]

 + [[https://github.com/helenecharlotte/continuousTMLE#examples-of-applying-the-code-to-simulated-data][Examples of applying the code to simulated data]]

  + [[https://github.com/helenecharlotte/continuousTMLE#targeting-time-specific-and-treatment-specific-survival-probabilities][Targeting time-specific and treatment-specific survival probabilities]]
  + [[https://github.com/helenecharlotte/continuousTMLE#targeting-the-time-specific-average-treatment-effect-ate-on-survival][Targeting the time-specific average treatment effect (ATE) on
    survival]]
  + [[https://github.com/helenecharlotte/continuousTMLE#targeting-survival-probabilities-simultaneously-across-multiple-time-points][Targeting survival probabilities simultaneously across multiple time-points]]

- [[https://github.com/helenecharlotte/continuousTMLE#tmle-for-competing-risks-analysis][TMLE for continuous-time competing risks analysis]]

 + [[https://github.com/helenecharlotte/continuousTMLE#simulated-data-examples-1][Simulated data examples]]

 + [[https://github.com/helenecharlotte/continuousTMLE#examples-of-applying-the-code-to-simulated-data-1][Examples of applying the code to data]]

  + [[https://github.com/helenecharlotte/continuousTMLE#targeting-the-cause-specific-cumulative-risks-simultaneously][Targeting the cause-specific cumulative risks simultaneously]]
  + [[https://github.com/helenecharlotte/continuousTMLE#targeting-the-cause-specific-cumulative-risks-simultaneously-across-multiple-time-points][Targeting the cause-specific cumulative risks simultaneously
    across multiple time-points]]



** Overview of code

Current implementation: 

- [[https://github.com/helenecharlotte/continuousTMLE/blob/master/R/contmle.R][R/contmle.R]]

- [[https://github.com/helenecharlotte/continuousTMLE/blob/master/R/cox.super.learner.R][R/cox.super.learner.R]]


For simulation study: 

- [[https://github.com/helenecharlotte/continuousTMLE/blob/master/R/sim.data.continuous.R][R/sim.data.continuous.R]]

- [[https://github.com/helenecharlotte/continuousTMLE/blob/master/simulation-contmle/run.fun.R][simulation-contmle/run.fun.R]]




* TMLE for survival analysis

** Simulated data examples

All data contain three continuous covariates, =L_1=, =L_2=, =L_3=, a
binary treatment, =A=, a time-to-event variable, =time=, and an event
indicator, =delta=. 

*** Setting 1

#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
# NOTE: you need to set the working directory  
source("./simulation-contmle/load.R")    
(dt1 <- sim.data2(500, setting=1, m=101))   
#+END_SRC


#+begin_example
      id      time delta A          L1         L2          L3
  1:   1 2.0631444     1 0  0.49139281 -0.6688724 0.291922718
  2:   2 2.1493063     1 0 -0.73285336  0.5850001 0.500198228
  3:   3 1.4273563     1 0 -0.14371713  0.5780268 0.445078787
  4:   4 0.4280762     1 1 -0.26399351 -0.3642358 0.450386852
  5:   5 0.8844077     1 0 -0.38961309  0.3991256 0.867301825
 ---                                                         
496: 496 0.2453018     1 1  0.22407892  0.9891128 0.980549826
497: 497 1.4340098     1 0  0.11135457 -0.7108160 0.006933557
498: 498 1.8405661     1 1 -0.91630937 -0.9992122 0.391603182
499: 499 0.7440901     0 1 -0.45349936 -0.6978073 0.435121550
500: 500 0.6051863     1 1 -0.01772394  0.5169929 0.821363185
#+end_example



*** Setting 2

#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
# NOTE: you need to set the working directory  
source("./simulation-contmle/load.R")    
(dt2 <- sim.data2(500, setting=2, m=30033))   
#+END_SRC


#+begin_example
      id      time delta A           L1         L2        L3
  1:   1 0.9471819     1 0  0.756822031 0.77002296 0.7797066
  2:   2 1.1323334     1 0 -0.065353703 0.35827118 0.7976352
  3:   3 1.7053282     1 1  0.656070347 0.20709002 0.5780152
  4:   4 0.8061263     1 1 -0.763604288 0.40173444 0.6358432
  5:   5 0.8088335     1 1  0.875432958 0.01411658 0.9980470
 ---                                                        
496: 496 0.7946299     1 1 -0.946018820 0.47053691 0.4194170
497: 497 0.8807391     1 0 -0.648760873 0.84350969 0.8831198
498: 498 1.2373449     1 1 -0.334965690 0.05032776 0.3214108
499: 499 0.7937388     1 1 -0.006926148 0.63071498 0.7458795
500: 500 0.1190475     1 0  0.820146986 0.84440805 0.5426060
#+end_example






** Examples of applying the code to simulated data


*** Targeting time-specific and treatment-specific survival probabilities

#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
# NOTE: you need to set the working directory  
source("./simulation-contmle/load.R")    
(run0 <- contmle(dt1, #-- dataset
                 treat.effect="0", #-- target the ate directly
                 tau=0.5, #-- time-point of interest
                 estimation=list("survival"=list(fit="cox", 
                                               model=Surv(time, delta==1)~A+L1.squared),
                                 "cens"=list(fit="cox",
                                             model=Surv(time, delta==0)~L1+L2+L3+A*L1)                                         
                                 )
                 ))     
#+END_SRC


: $init
:             tau=0.5
: init.est 0.08273712
: init.se  0.01390123
: 
: $tmle
:             tau=0.5
: tmle.est 0.04657883
: tmle.se  0.01377620

: $init
:             tau=0.5
: init.est 0.08909946
: init.se  0.01660139
: 
: $tmle
:             tau=0.5
: tmle.est 0.06933829
: tmle.se  0.01657499


#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
# NOTE: you need to set the working directory  
source("./simulation-contmle/load.R")    
(run1 <- contmle(dt1, #-- dataset
                 treat.effect="1", #-- target the ate directly
                 tau=0.5, #-- time-point of interest
                 estimation=list("survival"=list(fit="cox", 
                                               model=Surv(time, delta==1)~A+L1.squared),
                                 "cens"=list(fit="cox",
                                             model=Surv(time, delta==0)~L1+L2+L3+A*L1)                                         
                                 ) 
                 ))   
#+END_SRC


: $init
:             tau=0.5
: init.est 0.08203692
: init.se  0.02045089
: 
: $tmle
:             tau=0.5
: tmle.est 0.11721628
: tmle.se  0.02041782

: $init
:             tau=0.5
: init.est 0.07562680
: init.se  0.01850529
: 
: $tmle
:             tau=0.5
: tmle.est 0.09682654
: tmle.se  0.01847456


*** Targeting the time-specific average treatment effect (ATE) on survival

#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
# NOTE: you need to set the working directory  
source("./simulation-contmle/load.R")    
(run2 <- contmle(dt1, #-- dataset
                 treat.effect="ate", #-- target the ate directly
                 tau=0.5, #-- time-point of interest
                 estimation=list("survival"=list(fit="cox", 
                                               model=Surv(time, delta==1)~A+L1.squared),
                                 "cens"=list(fit="cox",
                                             model=Surv(time, delta==0)~L1+L2+L3+A*L1)                                         
                                 )
                 ))   
#+END_SRC


: $init
:                tau=0.5
: init.est -0.0007001979
: init.se   0.0246345062
: 
: $tmle
:             tau=0.5
: tmle.est 0.07052852
: tmle.se  0.02469477

: $init
:              tau=0.5
: init.est -0.01347265
: init.se   0.02472451
: 
: $tmle
:             tau=0.5
: tmle.est 0.02748492
: tmle.se  0.02472948






*** Targeting survival probabilities simultaneously across multiple time-points

#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
# NOTE: you need to set the working directory  
source("./simulation-contmle/load.R")    
(run3 <- contmle(dt1, #-- dataset
                 treat.effect="ate", #-- target the ate directly
                 tau=c(0.3, 0.5), #-- time-point of interest
                 estimation=list("survival"=list(fit="cox",  
                                               model=Surv(time, delta==1)~A+L1.squared),
                                 "cens"=list(fit="cox",
                                             model=Surv(time, delta==0)~L1+L2+L3+A*L1)                                         
                                 )
                 ))   
#+END_SRC


: $init
:               tau=0.3       tau=0.5
: init.est -0.000366087 -0.0007001979
: init.se   0.017949756  0.0246345062
: 
: $tmle
:             tau=0.3    tau=0.5
: tmle.est 0.04027219 0.07067547
: tmle.se  0.01798117 0.02469414

: $init
:               tau=0.3     tau=0.5
: init.est -0.005064993 -0.01347265
: init.se   0.015861703  0.02472451
: 
: $tmle
:             tau=0.3    tau=0.5
: tmle.est 0.00265876 0.02741378
: tmle.se  0.01586685 0.02472889








*** Use super learner for initial estimation 

#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
# NOTE: you need to set the working directory   
source("./simulation-contmle/load.R")      
(run3 <- contmle(dt1, #-- dataset
                 treat.effect="ate", #-- target the ate directly
                 tau=0.5, #-- time-point of interest
                 estimation=list("survival"=list(fit="sl", 
                                               model=Surv(time, delta==1)~A+L1.squared),
                                 "cens"=list(fit="sl",
                                             model=Surv(time, delta==0)~L1+L2+L3+A*L1)                                         
                                 ),
                 sl.models=list(
                     mod1=c(Surv(time, delta==1)~A+L1+L2+L3, changepoint=c(0.3, 0.7)),
                     mod2=c(Surv(time, delta==1)~A+L2.squared+L1*L2+L3, changepoint=NULL),
                     mod3=c(Surv(time, delta==1)~A+L1.squared+L1*L2+L3, changepoint=c(0.3, 0.7)),
                     mod4=c(Surv(time, delta==1)~A+L2.squared, changepoint=c(0.3, 0.7)),
                     mod5=c(Surv(time, delta==1)~A+L1.squared, changepoint=c(0.3, 0.7)),
                     mod6=c(Surv(time, delta==1)~A+L1.squared+L2+L3, changepoint=c(0.3, 0.7)),
                     mod7=c(Surv(time, delta==1)~A+L2.squared, changepoint=NULL),
                     mod8=c(Surv(time, delta==1)~A+L1.squared, changepoint=NULL),
                     mod9=c(Surv(time, delta==1)~A+L1+L2+L3, changepoint=NULL),
                     mod10=c(Surv(time, delta==1)~A*L1+L2+L3, changepoint=NULL),
                     mod11=c(Surv(time, delta==1)~A*L1.squared+L2+L3, changepoint=NULL)
                 ),  
                 verbose.sl=TRUE, 
                 ))       
#+END_SRC

#+begin_example
[1] "model picked for survival: A + L1.squared + L1 * L2 + L3"
[1] "changepoint picked: 0.7"
[1] "model picked for cens: A + L1.squared + L1 * L2 + L3"
[1] "changepoint picked: 0.3"
$init
            tau=0.5
init.est 0.05088319
init.se  0.02514863

$tmle
            tau=0.5
tmle.est 0.07081248
tmle.se  0.02516692

Warning message:
In fitter(X, Y, istrat, offset, init, control, weights = weights,  :
  Loglik converged before variable  1 ; beta may be infinite.
#+end_example


* TMLE for competing risks analysis

** Simulated data examples

All data contain three continuous covariates, =L_1=, =L_2=, =L_3=, a
binary treatment, =A=, a time-to-event variable, =time=, and an event
indicator, =delta=.

*** Setting 1

#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
# NOTE: you need to set the working directory  
source("./simulation-contmle/load.R")   
(dt1 <- sim.data2(500, setting=1, competing.risk=TRUE))  
#+END_SRC

#+begin_example
      id      time delta A          L1         L2        L3
  1:   1 0.2874422     1 0  0.30975138 -0.7685858 0.3152207
  2:   2 0.3277389     1 0  0.02027468  0.5996824 0.7876355
  3:   3 0.5929084     1 0 -0.56207753 -0.8157896 0.4990356
  4:   4 0.3566947     2 0 -0.23240904  0.6263003 0.9797428
  5:   5 0.4022813     1 1  0.42003211 -0.5027374 0.8166309
 ---                                                       
496: 496 0.8319554     2 1  0.70791783 -0.7384621 0.1793389
497: 497 0.5464264     2 0  0.33327201  0.5171843 0.1297940
498: 498 0.7545253     2 0 -0.18518105  0.4249485 0.4925814
499: 499 0.5686617     1 1 -0.38356117  0.9970010 0.1349552
500: 500 0.5134096     1 1 -0.11580208  0.3356330 0.3555878
#+end_example


*** Setting 2

#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
# NOTE: you need to set the working directory  
source("./simulation-contmle/load.R")   
(dt2 <- sim.data2(500, setting=2, competing.risk=TRUE))  
#+END_SRC

#+begin_example
      id      time delta A          L1        L2        L3
  1:   1 0.5799401     2 1  0.61881053 0.4555461 0.9244269
  2:   2 0.6195841     0 1 -0.05301504 0.9538462 0.5191956
  3:   3 0.3976385     2 0  0.81225760 0.8830862 0.2465510
  4:   4 0.1252781     1 1  0.80605090 0.1536068 0.6741928
  5:   5 0.1745883     1 1  0.95105817 0.6554411 0.9900094
 ---                                                      
496: 496 0.4873752     2 0 -0.01904145 0.8212517 0.8391338
497: 497 0.1826586     0 0 -0.66730849 0.9426368 0.8602731
498: 498 0.6606991     2 1 -0.36369797 0.9727633 0.8323750
499: 499 0.4425950     1 0  0.23650685 0.9604297 0.3021334
500: 500 0.7447092     1 1 -0.66147132 0.2512112 0.5502155
#+end_example


** Examples of applying the code to simulated data 

*** Targeting the cause 1 specific cumulative risk

#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
# NOTE: you need to set the working directory  
source("./simulation-contmle/load.R")   
(run1 <- contmle(dt2, #-- dataset
                 target=1, #-- go after cause 1 specific risk
                 treat.effect="ate", #-- target the ate directly
                 tau=0.5, #-- time-point of interest
                 estimation=list("cause1"=list(fit="cox",
                                               model=Surv(time, delta==1)~A+L1.squared),
                                 "cens"=list(fit="cox",
                                             model=Surv(time, delta==0)~L1+L2+L3+A*L1),
                                 "cause2"=list(fit="cox",
                                               model=Surv(time, delta==2)~A+L1+L2+L3)                                         
                                 )
                 ))  
#+END_SRC

#+begin_example
$init
$init$F1
             tau=0.5
init.est 0.007793466
init.se  0.040004181


$tmle
$tmle$F1
             tau=0.5
tmle.est 0.003432847
tmle.se  0.040002785
#+end_example


*** Targeting both cause-specific cumulative risks separately

#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
# NOTE: you need to set the working directory  
source("./simulation-contmle/load.R")    
(run2 <- contmle(dt2, #-- dataset
                 target=1:2, #-- go after cause 1 and cause 2 specific risks
                 iterative=TRUE, #-- use iterative tmle to target F1 and F2 separately
                 treat.effect="ate", #-- target the ate directly
                 tau=0.5, #-- time-point of interest
                 estimation=list("cause1"=list(fit="cox",
                                               model=Surv(time, delta==1)~A+L1.squared),
                                 "cens"=list(fit="cox",
                                             model=Surv(time, delta==0)~L1+L2+L3+A*L1),
                                 "cause2"=list(fit="cox",
                                               model=Surv(time, delta==2)~A+L1+L2+L3)                                         
                                 )
                 ))  
#+END_SRC

#+begin_example
$init
$init$F1
             tau=0.5
init.est 0.007793466
init.se  0.040004181

$init$F2
             tau=0.5
init.est -0.09378281
init.se   0.03692451


$tmle
$tmle$F1
             tau=0.5
tmle.est 0.003432847
tmle.se  0.040002785

$tmle$F2
             tau=0.5
tmle.est -0.08613062
tmle.se   0.03692450
#+end_example




*** Targeting the cause-specific cumulative risks simultaneously 


#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
# NOTE: you need to set the working directory  
source("./simulation-contmle/load.R")    
(run3 <- contmle(dt2, #-- dataset
                 target=1:2, #-- go after cause 1 and cause 2 specific risks
                 iterative=FALSE, #-- use one-step tmle to target F1 and F2 separately
                 treat.effect="ate", #-- target the ate directly
                 tau=0.5, #-- time-point of interest
                 estimation=list("cause1"=list(fit="cox",
                                               model=Surv(time, delta==1)~A+L1.squared),
                                 "cens"=list(fit="cox",
                                             model=Surv(time, delta==0)~L1+L2+L3+A*L1),
                                 "cause2"=list(fit="cox",
                                               model=Surv(time, delta==2)~A+L1+L2+L3)                                         
                                 )
                 ))   
#+END_SRC

#+begin_example
$init
$init$F1
             tau=0.5
init.est 0.007793466
init.se  0.040004181

$init$F2
             tau=0.5
init.est -0.09378281
init.se   0.03692451


$tmle
$tmle$F1
             tau=0.5
tmle.est 0.003542553
tmle.se  0.040002546

$tmle$F2
             tau=0.5
tmle.est -0.08624101
tmle.se   0.03692414
#+end_example



*** Targeting the cause-specific cumulative risks simultaneously across multiple time-points



#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
# NOTE: you need to set the working directory  
source("./simulation-contmle/load.R")    
(run4 <- contmle(dt2, #-- dataset
                 target=1:2, #-- go after cause 1 and cause 2 specific risks
                 iterative=FALSE, #-- use one-step tmle to target F1 and F2 separately
                 treat.effect="ate", #-- target the ate directly
                 tau=c(0.3, 0.5), #-- time-point of interest
                 estimation=list("cause1"=list(fit="cox",
                                               model=Surv(time, delta==1)~A+L1.squared),
                                 "cens"=list(fit="cox",
                                             model=Surv(time, delta==0)~L1+L2+L3+A*L1),
                                 "cause2"=list(fit="cox",
                                               model=Surv(time, delta==2)~A+L1+L2+L3)                                         
                                 )
                 ))   
#+END_SRC

#+begin_example
$init
$init$F1
              tau=0.3     tau=0.5
init.est -0.001742215 0.007793466
init.se   0.028741879 0.040004181

$init$F2
             tau=0.3     tau=0.5
init.est -0.05149133 -0.09378281
init.se   0.02771378  0.03692451


$tmle
$tmle$F1
            tau=0.3     tau=0.5
tmle.est 0.01948492 0.003680884
tmle.se  0.02874492 0.040002053

$tmle$F2
             tau=0.3     tau=0.5
tmle.est -0.04689139 -0.08623811
tmle.se   0.02771312  0.03692375
#+end_example



** Code for simulation studies

#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
# NOTE: you need to set the working directory 
source("./simulation-contmle/load.R") 
test1 <- run.fun(M=1, n=1000, competing.risk=TRUE, 
                 target=1, tau=0.5, 
                 setting=2,
                 censoring.informative=TRUE,
                 iterative=TRUE, 
                 no_cores=1)    
#+END_SRC

#+begin_example
[1] "m=1"
$`m=1`
$`m=1`$init
$`m=1`$init$F1
             tau=0.5
init.est -0.06945745
init.se   0.02777824


$`m=1`$km
$`m=1`$km$F1
           tau=0.5
km.est -0.03353986
km.se   0.02819749


$`m=1`$tmle
$`m=1`$tmle$F1
             tau=0.5
tmle.est -0.04757723
tmle.se   0.02778435
#+end_example




*  Dependencies :noexport:

** R-version

The code has been tested with the following R version

#+BEGIN_SRC R  :results output :exports results  :session *R* :cache yes  
version
#+END_SRC

#+begin_example
               _                           
platform       x86_64-pc-linux-gnu         
arch           x86_64                      
os             linux-gnu                   
system         x86_64, linux-gnu           
status                                     
major          4                           
minor          0.2                         
year           2020                        
month          06                          
day            22                          
svn rev        78730                       
language       R                           
version.string R version 4.0.2 (2020-06-22)
nickname       Taking Off Again
#+end_example

and the following package versions:

#+BEGIN_SRC R  :results output raw drawer  :exports results  :session *R* :cache yes  
pp <- c("data.table", "zoo", "stringr", "ltmle", "parallel", "foreach", "doParallel")
Publish::org(data.table(Package=pp,Version=sapply(pp,function(x) as.character(packageVersion(x)))))
#+END_SRC

:results:
| Package    | Version |
|------------+---------|
| data.table |  1.13.0 |
| zoo        |   1.8.8 |
| stringr    |   1.4.0 |
| ltmle      |   1.2.0 |
| parallel   |   4.0.2 |
| foreach    |   1.5.0 |
| doParallel |  1.0.15 |
:end:

