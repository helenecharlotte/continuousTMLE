# Web-appendix-continuous-time-TMLE
* Continuous-time TMLE

** Overview 

- [[https://github.com/helenecharlotte/continuousTMLE#tmle-for-survival-analysis][TMLE for continuous-time survival analysis]]

 + [[https://github.com/helenecharlotte/continuousTMLE#simulated-data-examples-1][Simulated data examples]]

 + [[https://github.com/helenecharlotte/continuousTMLE#examples-of-applying-the-code-to-simulated-data][Examples of applying the code to simulated data]]

  + [[https://github.com/helenecharlotte/continuousTMLE#targeting-survival-probabilities-simultaneously-across-multiple-time-points][Targeting survival probabilities simultaneously across multiple time-points]]

- [[https://github.com/helenecharlotte/continuousTMLE#tmle-for-competing-risks-analysis][TMLE for continuous-time competing risks analysis]]

 + [[https://github.com/helenecharlotte/continuousTMLE#simulated-data-examples-1][Simulated data examples]]

 + [[https://github.com/helenecharlotte/continuousTMLE#examples-of-applying-the-code-to-simulated-data-1][Examples of applying the code to data]]

** Overview of code

- [[https://github.com/helenecharlotte/continuousTMLE/blob/master/R/contmle.R][contmle.R]]

- [[https://github.com/helenecharlotte/continuousTMLE/blob/master/R/sim.data.continuous.R][sim.data.continuous.R]]

- [[https://github.com/helenecharlotte/continuousTMLE/blob/master/R/cox.super.learner.R][cox.super.learner.R]]


* TMLE for survival analysis

** Simulated data examples

All data contain three continuous covariates, =L_1=, =L_2=, =L_3=, a
binary treatment, =A=, a time-to-event variable, =time=, and an event
indicator, =delta=. 

*** Setting 1

#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
# NOTE: you need to set the working directory  
source("./simulation-contmle/load.R")    
(dt1 <- sim.data2(500, setting=1))   
#+END_SRC

#+begin_example
      id      time delta A          L1          L2        L3
  1:   1 0.8100002     1 0  0.94261020  0.27985342 0.1031382
  2:   2 1.4502260     0 1 -0.25797067 -0.47395586 0.4651436
  3:   3 0.8296075     1 0  0.06520837 -0.88843887 0.8656481
  4:   4 0.9951963     1 1  0.50515942  0.92833757 0.7473536
  5:   5 0.5157014     0 0  0.75570359  0.49506938 0.3118374
 ---                                                        
496: 496 4.4054541     1 1 -0.43756861  0.29171967 0.7055158
497: 497 1.6474467     1 1  0.75889535 -0.54660755 0.3045856
498: 498 0.5935097     1 0  0.35789923 -0.84041999 0.9514172
499: 499 2.2699648     1 1 -0.35127632 -0.01062143 0.3641394
500: 500 2.6056930     0 1 -0.75344235  0.66964005 0.3897868
#+end_example


*** Setting 2

#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
# NOTE: you need to set the working directory  
source("./simulation-contmle/load.R")    
(dt2 <- sim.data2(500, setting=2))   
#+END_SRC

#+begin_example
      id      time delta A         L1        L2         L3
  1:   1 0.4132532     1 1  0.7061089 0.1952092 0.05819595
  2:   2 0.4642015     1 1 -0.2134748 0.3070825 0.95670351
  3:   3 0.6220027     1 1 -0.9355447 0.9640623 0.31208394
  4:   4 0.9925885     0 0  0.4689362 0.5076957 0.08968828
  5:   5 1.8214260     1 0 -0.2059220 0.5135538 0.92813930
 ---                                                      
496: 496 1.3029924     1 1 -0.7585462 0.6557159 0.65152925
497: 497 0.7232362     1 0  0.3929011 0.6974605 0.87480652
498: 498 0.3991887     1 1 -0.4575361 0.6280713 0.32450182
499: 499 0.1726519     1 1  0.5882465 0.4211234 0.41523119
500: 500 0.8296751     1 0 -0.7846494 0.8117789 0.40373350
#+end_example




** Examples of applying the code to simulated data

*** Targeting the time-specific survival probability

#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
# NOTE: you need to set the working directory  
source("./simulation-contmle/load.R")    
(run1 <- contmle(dt1, #-- dataset
                 treat.effect="ate", #-- target the ate directly
                 tau=0.5, #-- time-point of interest
                 estimation=list("cause1"=list(fit="cox", 
                                               model=Surv(time, delta==1)~A+L1.squared),
                                 "cens"=list(fit="cox",
                                             model=Surv(time, delta==0)~L1+L2+L3+A*L1)                                         
                                 )
                 ))  
#+END_SRC

: $init
:              tau=0.5
: init.est -0.01347265
: init.se   0.02472451
: 
: $tmle
:             tau=0.5
: tmle.est 0.02748492
: tmle.se  0.02472948






*** Targeting survival probabilities simultaneously across multiple time-points

#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
# NOTE: you need to set the working directory  
source("./simulation-contmle/load.R")    
(run2 <- contmle(dt1, #-- dataset
                 treat.effect="ate", #-- target the ate directly
                 tau=c(0.3, 0.5), #-- time-point of interest
                 estimation=list("cause1"=list(fit="cox",  
                                               model=Surv(time, delta==1)~A+L1.squared),
                                 "cens"=list(fit="cox",
                                             model=Surv(time, delta==0)~L1+L2+L3+A*L1)                                         
                                 )
                 ))  
#+END_SRC

: $init
:               tau=0.3     tau=0.5
: init.est -0.005064993 -0.01347265
: init.se   0.015861703  0.02472451
: 
: $tmle
:             tau=0.3    tau=0.5
: tmle.est 0.00265876 0.02741378
: tmle.se  0.01586685 0.02472889








*** Use super learner for initial estimation 

#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
# NOTE: you need to set the working directory   
source("./simulation-contmle/load.R")    
(run3 <- contmle(dt1, #-- dataset
                 treat.effect="ate", #-- target the ate directly
                 tau=0.5, #-- time-point of interest
                 estimation=list("cause1"=list(fit="sl", 
                                               model=Surv(time, delta==1)~A+L1.squared),
                                 "cens"=list(fit="sl",
                                             model=Surv(time, delta==0)~L1+L2+L3+A*L1)                                         
                                 ),
                 sl.models=list(
                     mod1=c(Surv(time, delta==1)~A+L1+L2+L3, changepoint=c(0.3, 0.7, 0.9)),
                     mod2=c(Surv(time, delta==1)~A+L2.squared+L1*L2+L3, changepoint=NULL),
                     mod3=c(Surv(time, delta==1)~A+L1.squared+L1*L2+L3, changepoint=c(0.3, 0.7, 0.9)),
                     mod4=c(Surv(time, delta==1)~A+L2.squared, changepoint=c(0.3, 0.7, 0.9)),
                     mod5=c(Surv(time, delta==1)~A+L1.squared, changepoint=c(0.3, 0.7, 0.9)),
                     mod6=c(Surv(time, delta==1)~A+L1.squared+L2+L3, changepoint=c(0.3, 0.7, 0.9)),
                     mod7=c(Surv(time, delta==1)~A+L2.squared, changepoint=NULL),
                     mod8=c(Surv(time, delta==1)~A+L1.squared, changepoint=NULL),
                     mod9=c(Surv(time, delta==1)~A+L1+L2+L3, changepoint=NULL),
                     mod10=c(Surv(time, delta==1)~A*L1+L2+L3, changepoint=NULL),
                     mod11=c(Surv(time, delta==1)~A*L1.squared+L2+L3, changepoint=NULL)
                 )
                 ))  
#+END_SRC

#+begin_example
[1] "model picked by cox super learner: mod34"
[1] "model picked by cox super learner: mod34"
$init
            tau=0.5
init.est 0.02229132
init.se  0.02480141

$tmle
            tau=0.5
tmle.est 0.02696983
tmle.se  0.02480234

There were 20 warnings (use warnings() to see them)
#+end_example




* TMLE for competing risks analysis

** Simulated data examples

All data contain three continuous covariates, =L_1=, =L_2=, =L_3=, a
binary treatment, =A=, a time-to-event variable, =time=, and an event
indicator, =delta=.

*** Setting 1

#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
# NOTE: you need to set the working directory  
source("./simulation-contmle/load.R")   
(dt1 <- sim.data2(500, setting=1, competing.risk=TRUE))  
#+END_SRC

#+begin_example
      id      time delta A          L1         L2        L3
  1:   1 0.2874422     1 0  0.30975138 -0.7685858 0.3152207
  2:   2 0.3277389     1 0  0.02027468  0.5996824 0.7876355
  3:   3 0.5929084     1 0 -0.56207753 -0.8157896 0.4990356
  4:   4 0.3566947     2 0 -0.23240904  0.6263003 0.9797428
  5:   5 0.4022813     1 1  0.42003211 -0.5027374 0.8166309
 ---                                                       
496: 496 0.8319554     2 1  0.70791783 -0.7384621 0.1793389
497: 497 0.5464264     2 0  0.33327201  0.5171843 0.1297940
498: 498 0.7545253     2 0 -0.18518105  0.4249485 0.4925814
499: 499 0.5686617     1 1 -0.38356117  0.9970010 0.1349552
500: 500 0.5134096     1 1 -0.11580208  0.3356330 0.3555878
#+end_example


*** Setting 2

#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
# NOTE: you need to set the working directory  
source("./simulation-contmle/load.R")   
(dt2 <- sim.data2(500, setting=2, competing.risk=TRUE))  
#+END_SRC

#+begin_example
      id      time delta A          L1        L2        L3
  1:   1 0.5799401     2 1  0.61881053 0.4555461 0.9244269
  2:   2 0.6195841     0 1 -0.05301504 0.9538462 0.5191956
  3:   3 0.3976385     2 0  0.81225760 0.8830862 0.2465510
  4:   4 0.1252781     1 1  0.80605090 0.1536068 0.6741928
  5:   5 0.1745883     1 1  0.95105817 0.6554411 0.9900094
 ---                                                      
496: 496 0.4873752     2 0 -0.01904145 0.8212517 0.8391338
497: 497 0.1826586     0 0 -0.66730849 0.9426368 0.8602731
498: 498 0.6606991     2 1 -0.36369797 0.9727633 0.8323750
499: 499 0.4425950     1 0  0.23650685 0.9604297 0.3021334
500: 500 0.7447092     1 1 -0.66147132 0.2512112 0.5502155
#+end_example


** Examples of applying the code to simulated data 

*** Targeting the cause 1 specific cumulative risk

#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
# NOTE: you need to set the working directory  
source("./simulation-contmle/load.R")   
(run1 <- contmle(dt2, #-- dataset
                 target=1, #-- go after cause 1 specific risk
                 treat.effect="ate", #-- target the ate directly
                 tau=0.5, #-- time-point of interest
                 estimation=list("cause1"=list(fit="cox",
                                               model=Surv(time, delta==1)~A+L1.squared),
                                 "cens"=list(fit="cox",
                                             model=Surv(time, delta==0)~L1+L2+L3+A*L1),
                                 "cause2"=list(fit="cox",
                                               model=Surv(time, delta==2)~A+L1+L2+L3)                                         
                                 )
                 ))  
#+END_SRC

#+begin_example
$init
$init$F1
             tau=0.5
init.est 0.007793466
init.se  0.040004181


$tmle
$tmle$F1
             tau=0.5
tmle.est 0.003432847
tmle.se  0.040002785
#+end_example


*** Targeting both cause-specific cumulative risks separately

#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
# NOTE: you need to set the working directory  
source("./simulation-contmle/load.R")    
(run2 <- contmle(dt2, #-- dataset
                 target=1:2, #-- go after cause 1 and cause 2 specific risks
                 iterative=TRUE, #-- use iterative tmle to target F1 and F2 separately
                 treat.effect="ate", #-- target the ate directly
                 tau=0.5, #-- time-point of interest
                 estimation=list("cause1"=list(fit="cox",
                                               model=Surv(time, delta==1)~A+L1.squared),
                                 "cens"=list(fit="cox",
                                             model=Surv(time, delta==0)~L1+L2+L3+A*L1),
                                 "cause2"=list(fit="cox",
                                               model=Surv(time, delta==2)~A+L1+L2+L3)                                         
                                 )
                 ))  
#+END_SRC

#+begin_example
$init
$init$F1
             tau=0.5
init.est 0.007793466
init.se  0.040004181

$init$F2
             tau=0.5
init.est -0.09378281
init.se   0.03692451


$tmle
$tmle$F1
             tau=0.5
tmle.est 0.003432847
tmle.se  0.040002785

$tmle$F2
             tau=0.5
tmle.est -0.08613062
tmle.se   0.03692450
#+end_example




*** Targeting the cause-specific cumulative risks simultaneously 


#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
# NOTE: you need to set the working directory  
source("./simulation-contmle/load.R")    
(run3 <- contmle(dt2, #-- dataset
                 target=1:2, #-- go after cause 1 and cause 2 specific risks
                 iterative=FALSE, #-- use one-step tmle to target F1 and F2 separately
                 treat.effect="ate", #-- target the ate directly
                 tau=0.5, #-- time-point of interest
                 estimation=list("cause1"=list(fit="cox",
                                               model=Surv(time, delta==1)~A+L1.squared),
                                 "cens"=list(fit="cox",
                                             model=Surv(time, delta==0)~L1+L2+L3+A*L1),
                                 "cause2"=list(fit="cox",
                                               model=Surv(time, delta==2)~A+L1+L2+L3)                                         
                                 )
                 ))   
#+END_SRC

#+begin_example
$init
$init$F1
             tau=0.5
init.est 0.007793466
init.se  0.040004181

$init$F2
             tau=0.5
init.est -0.09378281
init.se   0.03692451


$tmle
$tmle$F1
             tau=0.5
tmle.est 0.003542553
tmle.se  0.040002546

$tmle$F2
             tau=0.5
tmle.est -0.08624101
tmle.se   0.03692414
#+end_example



*** Targeting the cause-specific cumulative risks simultaneously across multiple time-points



#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
# NOTE: you need to set the working directory  
source("./simulation-contmle/load.R")    
(run4 <- contmle(dt2, #-- dataset
                 target=1:2, #-- go after cause 1 and cause 2 specific risks
                 iterative=FALSE, #-- use one-step tmle to target F1 and F2 separately
                 treat.effect="ate", #-- target the ate directly
                 tau=c(0.3, 0.5), #-- time-point of interest
                 estimation=list("cause1"=list(fit="cox",
                                               model=Surv(time, delta==1)~A+L1.squared),
                                 "cens"=list(fit="cox",
                                             model=Surv(time, delta==0)~L1+L2+L3+A*L1),
                                 "cause2"=list(fit="cox",
                                               model=Surv(time, delta==2)~A+L1+L2+L3)                                         
                                 )
                 ))   
#+END_SRC

#+begin_example
$init
$init$F1
              tau=0.3     tau=0.5
init.est -0.001742215 0.007793466
init.se   0.028741879 0.040004181

$init$F2
             tau=0.3     tau=0.5
init.est -0.05149133 -0.09378281
init.se   0.02771378  0.03692451


$tmle
$tmle$F1
            tau=0.3     tau=0.5
tmle.est 0.01948492 0.003680884
tmle.se  0.02874492 0.040002053

$tmle$F2
             tau=0.3     tau=0.5
tmle.est -0.04689139 -0.08623811
tmle.se   0.02771312  0.03692375
#+end_example



** Code for simulation studies

#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache yes  
# NOTE: you need to set the working directory 
source("./simulation-contmle/load.R") 
test1 <- run.fun(M=1, n=1000, competing.risk=TRUE, 
                 target=1, tau=0.5, 
                 setting=2,
                 censoring.informative=TRUE,
                 iterative=TRUE, 
                 no_cores=1)    
#+END_SRC

#+begin_example
[1] "m=1"
$`m=1`
$`m=1`$init
$`m=1`$init$F1
             tau=0.5
init.est -0.06945745
init.se   0.02777824


$`m=1`$km
$`m=1`$km$F1
           tau=0.5
km.est -0.03353986
km.se   0.02819749


$`m=1`$tmle
$`m=1`$tmle$F1
             tau=0.5
tmle.est -0.04757723
tmle.se   0.02778435
#+end_example




*  Dependencies :noexport:

** R-version

The code has been tested with the following R version

#+BEGIN_SRC R  :results output :exports results  :session *R* :cache yes  
version
#+END_SRC

#+begin_example
               _                           
platform       x86_64-pc-linux-gnu         
arch           x86_64                      
os             linux-gnu                   
system         x86_64, linux-gnu           
status                                     
major          4                           
minor          0.2                         
year           2020                        
month          06                          
day            22                          
svn rev        78730                       
language       R                           
version.string R version 4.0.2 (2020-06-22)
nickname       Taking Off Again
#+end_example

and the following package versions:

#+BEGIN_SRC R  :results output raw drawer  :exports results  :session *R* :cache yes  
pp <- c("data.table", "zoo", "stringr", "ltmle", "parallel", "foreach", "doParallel")
Publish::org(data.table(Package=pp,Version=sapply(pp,function(x) as.character(packageVersion(x)))))
#+END_SRC

:results:
| Package    | Version |
|------------+---------|
| data.table |  1.13.0 |
| zoo        |   1.8.8 |
| stringr    |   1.4.0 |
| ltmle      |   1.2.0 |
| parallel   |   4.0.2 |
| foreach    |   1.5.0 |
| doParallel |  1.0.15 |
:end:

